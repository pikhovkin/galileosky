from unittest import TestCase
from contextlib import contextmanager

from galileosky import Packet, tags


class Test(TestCase):
    @staticmethod
    @contextmanager
    def register_custom_tag(tag):
        old_tag = tags.tags[tag.id]
        Packet.register(tag)
        yield
        Packet.register(old_tag)

    def _test_packet(self, msg):
        headers, data = Packet.unpack(msg)
        packet = Packet()
        for record in data:
            for k, v in record.items():
                packet.add(k, v)

        data, crc16 = packet.pack(is_archive=headers['is_archive'])
        self.assertTrue(data == msg)
        self.assertTrue(headers['crc16'] == crc16)

    def test_first_packet(self):
        # msg = bytes.fromhex('0117800182021003383632303537303437373435353331043200B548')
        msg = bytes.fromhex('01178004320020E17ADF52300EAC4F5E0340B610053300004604A2FE')
        self._test_packet(msg)

    def test_main_packet(self):
        msg = bytes.fromhex('01E783100000204E83FF5C30F300000000000000003300000000340000350040013A413F3042FE0E100100208D83FF5C30F300000000000000003300000000340000350040003A413B2E42080F100200200684FF5C30F300000000000000003300000000340000350040003A412E3042220F100300206B84FF5C30F300000000000000003300000000340000350040003A41453042390F100400207684FF5C30F300000000000000003300000000340000350040003A41DF2D423A0F100500208184FF5C30F300000000000000003300000000340000350040003A415B30423B0F100600208B84FF5C30F300000000000000003300000000340000350040003A412B2E423E0F100700209684FF5C30F300000000000000003300000000340000350040003A41F22D423F0F10080020A184FF5C30F300000000000000003300000000340000350040003A41832E423E0F10090020AC84FF5C30F300000000000000003300000000340000350040003A41493042420F100A0020B784FF5C30F300000000000000003300000000340000350040003A413A3042430F100B0020C284FF5C30F300000000000000003300000000340000350040003A413D3042430F100C0020CD84FF5C30F300000000000000003300000000340000350040003A411F3042450F100D0020D884FF5C30F300000000000000003300000000340000350040003A412A2D42460F100E0020E384FF5C30F300000000000000003300000000340000350040003A41333042480F100F0020EE84FF5C30F300000000000000003300000000340000350040003A41473042480F10100020F984FF5C30F300000000000000003300000000340000350040003A41253042470F101100200485FF5C30F300000000000000003300000000340000350040003A413830424A0F101200200F85FF5C30F300000000000000003300000000340000350040003A410A2E424B0F101300201A85FF5C30F300000000000000003300000000340000350040003A413630424B0F101400202585FF5C30F300000000000000003300000000340000350040003A413C30424F0F101500203085FF5C30F300000000000000003300000000340000350040003A41423042500F101600203B85FF5C30F300000000000000003300000000340000350040003A413C3042500F101700204685FF5C30F300000000000000003300000000340000350040003A41423042500F101800205185FF5C30F300000000000000003300000000340000350040003A414F3042500F101900205C85FF5C30F300000000000000003300000000340000350040003A413D3042510F101A00206785FF5C30F300000000000000003300000000340000350040003A412B3042520FA52D')
        self._test_packet(msg)

    def test_unpack_with_header_packet(self):
        HARDWARE = 10
        BASE_FIRMWARE = 20
        NULL_FIRMWARE = 0
        FIRMWARE = 1

        class Tag02(tags.Tag02):
            @classmethod
            def to_dict(cls, value, record, header_packet, conf):
                hw = record.get(tags.Tag01.id, header_packet.get(tags.Tag01.id, {})).get('hardware', 0)
                if hw == HARDWARE:
                    return {cls.name: FIRMWARE}
                return {cls.name: NULL_FIRMWARE}

        packet = Packet()
        packet.add(tags.Tag02.id, dict(firmware=BASE_FIRMWARE))
        data, crc16 = packet.pack()

        headers, packet = Packet.extract(data)
        self.assertTrue(packet[0][tags.Tag02.id]['firmware'] == BASE_FIRMWARE)

        with self.register_custom_tag(Tag02):
            headers, packet = Packet.extract(data)
            self.assertTrue(packet[0][tags.Tag02.id]['firmware'] == NULL_FIRMWARE)

        header_packet = {
            tags.Tag01.id: {'hardware': HARDWARE}
        }
        with self.register_custom_tag(Tag02):
            headers, packet = Packet.extract(data, header_packet=header_packet)
            self.assertTrue(packet[0][tags.Tag02.id]['firmware'] == FIRMWARE)

        header_packet = {
            1: {'hardware': 9}
        }
        with self.register_custom_tag(Tag02):
            headers, packet = Packet.extract(data, header_packet=header_packet)
            self.assertTrue(packet[0][tags.Tag02.id]['firmware'] == NULL_FIRMWARE)
